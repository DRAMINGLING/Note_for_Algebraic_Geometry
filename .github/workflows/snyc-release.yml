name: sync release

# 触发条件：可选（按需选择）
on:
  # 1. 手动触发（推荐测试用）
  workflow_dispatch:
  # 2. 当有新Release发布时自动触发
  release:
    types: [published]
       
jobs:
  sync-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 定义环境变量（需修改以下变量为实际值）
        id: vars
        run: |
          echo "SOURCE_OWNER=DRAMINGLING" >> $GITHUB_ENV          # 源仓库所有者（必填修改）
          echo "SOURCE_REPO=Note_for_Algebraic_Varieties" >> $GITHUB_ENV  # 源仓库名称（必填修改）
          echo "RELEASE_TAG=release" >> $GITHUB_ENV              # 目标 Release 标签（如需修改请调整）
          echo "SOURCE_FILE_NAME=main.pdf" >> $GITHUB_ENV        # 源 Release 中的文件名（必填修改）
          echo "TARGET_OWNER=DRAMINGLING" >> $GITHUB_ENV         # 目标仓库所有者（必填修改）
          echo "TARGET_REPO=Documents" >> $GITHUB_ENV            # 目标仓库名称（必填修改）
          echo "TARGET_FILE_NAME=Note for Algebraic Varieties.pdf" >> $GITHUB_ENV  # 目标文件名（必填修改）
          echo "TARGET_BRANCH=main" >> $GITHUB_ENV               # 目标仓库分支（如需修改请调整）

      - name: 2. 获取 Release 中目标文件的下载 URL
        id: get-release-asset
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/{owner}/{repo}/releases/tags/{tag}
          owner: ${{ env.SOURCE_OWNER }}
          repo: ${{ env.SOURCE_REPO }}
          tag: ${{ env.RELEASE_TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}
        outputs:
          asset_url: ${{ fromJson(steps.get-release-asset.outputs.data).assets[0].url }}  # 假设该 Release 仅包含 main.pdf 一个资产

      - name: 3. 下载 Release 中的 PDF 文件
        id: download-pdf
        run: |
          # 下载文件并保存为临时文件
          curl -L \
            -H "Accept: application/octet-stream" \
            -H "Authorization: token ${{ secrets.UPDATE_TEX_FILE }}" \
            ${{ steps.get-release-asset.outputs.asset_url }} \
            -o temp.pdf

      - name: 4. 将 PDF 文件推送到目标仓库（根目录）
        uses: octokit/request-action@v2.x
        with:
          route: PUT /repos/{owner}/{repo}/contents/{path}
          owner: ${{ env.TARGET_OWNER }}
          repo: ${{ env.TARGET_REPO }}
          path: ${{ env.TARGET_FILE_NAME }}  # 目标仓库根目录的文件名
          message: "Sync Note for Algebraic Varieties PDF from release tag"  # 提交信息
          content: ${{ steps.download-pdf.outputs.content_b64 }}  # 文件Base64编码内容
          branch: ${{ env.TARGET_BRANCH }}
        env:
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}

      - name: 辅助步骤：将下载的PDF转为Base64
        id: encode-pdf
        run: |
          CONTENT_B64=$(base64 -w 0 temp.pdf)
          echo "content_b64=$CONTENT_B64" >> $GITHUB_OUTPUT
