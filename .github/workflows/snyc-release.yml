name: Sync Release PDF to Documents Repository

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°releaseï¼‰'
        required: false
        default: ''

permissions:
  contents: write
  packages: read

jobs:
  sync-pdf-file:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡ï¼ˆå®‰è£…å¿…è¦å·¥å…·ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          # æ£€æŸ¥ç³»ç»Ÿå‚æ•°é•¿åº¦é™åˆ¶ï¼ˆå¯é€‰ï¼‰
          echo "ç³»ç»Ÿå‚æ•°é•¿åº¦é™åˆ¶ï¼š$(getconf ARG_MAX) å­—èŠ‚"

      - name: 2. è·å–ç›®æ ‡Releaseçš„PDFæ–‡ä»¶ä¿¡æ¯
        id: get_release_asset
        env:
          OWNER: DRAMINGLING          # éœ€è¦ä¿®æ”¹ï¼šGitHubç”¨æˆ·å
          SOURCE_REPO: Note_for_Algebraic_Varieties  # éœ€è¦ä¿®æ”¹ï¼šæºä»“åº“å
          ASSET_NAME: main.pdf        # éœ€è¦ä¿®æ”¹ï¼šæºReleaseä¸­çš„æ–‡ä»¶å
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}
        run: |
          # è·å–Releaseä¿¡æ¯
          if [ -z "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$SOURCE_REPO/releases/latest")
          else
            RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$OWNER/$SOURCE_REPO/releases/tags/${{ github.event.inputs.release_tag }}")
          fi

          # æå–PDFä¸‹è½½URL
          ASSET_URL=$(echo "$RELEASE_INFO" | jq -r --arg name "$ASSET_NAME" \
            '.assets[] | select(.name == $name) | .browser_download_url')

          if [ "$ASSET_URL" = "null" ] || [ -z "$ASSET_URL" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªåœ¨Releaseä¸­æ‰¾åˆ°åä¸º $ASSET_NAME çš„æ–‡ä»¶"
            exit 1
          fi

          echo "ASSET_URL=$ASSET_URL" >> $GITHUB_OUTPUT

      - name: 3. ä¸‹è½½PDFæ–‡ä»¶å¹¶æ£€æµ‹å¤§å°
        id: download_file
        run: |
          # ä¸‹è½½æ–‡ä»¶
          curl -s -L ${{ steps.get_release_asset.outputs.ASSET_URL }} -o main.pdf
          
          # æ£€æµ‹æ–‡ä»¶å¤§å°ï¼ˆå•ä½ï¼šMBï¼‰
          FILE_SIZE=$(du -m main.pdf | awk '{print $1}')
          echo "ğŸ“„ ä¸‹è½½çš„PDFæ–‡ä»¶å¤§å°ï¼š$FILE_SIZE MB"
          
          # é™åˆ¶æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆGitHub APIå•æ¬¡ä¸Šä¼ é™åˆ¶100MBï¼Œç•™ä½™é‡è®¾95MBï¼‰
          MAX_SIZE=95
          if [ $FILE_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶å¤§å°ï¼ˆ$FILE_SIZE MBï¼‰è¶…è¿‡é™åˆ¶ï¼ˆ$MAX_SIZE MBï¼‰ï¼Œæ— æ³•å•æ¬¡ä¸Šä¼ "
            exit 1
          fi
          
          echo "FILE_SIZE=$FILE_SIZE" >> $GITHUB_OUTPUT

      - name: 4. ç”ŸæˆAPIè¯·æ±‚ä½“ï¼ˆæ–‡ä»¶æ–¹å¼ä¼ é€’è¶…é•¿å†…å®¹ï¼‰
        id: generate_payload
        env:
          TARGET_FILENAME: Note for Algebraic Varieties  # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡æ–‡ä»¶å
        run: |
          # 1. å°†Base64å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆé¿å…å‘½ä»¤è¡Œå‚æ•°è¿‡é•¿ï¼‰
          base64 -w 0 main.pdf > pdf_base64.txt
          
          # 2. æ„é€ JSONè¯·æ±‚ä½“ï¼ˆä»æ–‡ä»¶è¯»å–Base64å†…å®¹ï¼‰
          jq -n \
            --arg content "$(cat pdf_base64.txt)" \
            --arg message "Sync PDF from Note_for_Algebraic_Varieties release (size: ${{ steps.download_file.outputs.FILE_SIZE }}MB)" \
            --arg filename "$TARGET_FILENAME" \
            '{
              message: $message,
              content: $content,
              branch: "main"  # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡ä»“åº“åˆ†æ”¯
            }' > payload.json
          
          # éªŒè¯è¯·æ±‚ä½“ï¼ˆå¯é€‰ï¼‰
          echo "âœ… è¯·æ±‚ä½“ç”Ÿæˆå®Œæˆï¼Œå¤§å°ï¼š$(du -k payload.json | awk '{print $1}') KB"

      - name: 5. æ¨é€æ–‡ä»¶åˆ°Documentsä»“åº“
        env:
          OWNER: DRAMINGLING          # éœ€è¦ä¿®æ”¹ï¼šGitHubç”¨æˆ·å
          TARGET_REPO: Documents       # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡ä»“åº“å
          TARGET_FILENAME: Note for Algebraic Varieties  # éœ€è¦ä¿®æ”¹ï¼šç›®æ ‡æ–‡ä»¶å
          GITHUB_TOKEN: ${{ secrets.UPDATE_TEX_FILE }}
        run: |
          # æ¨é€æ–‡ä»¶ï¼ˆä½¿ç”¨æ–‡ä»¶ä¼ é€’JSONä½“ï¼Œé¿å…å‚æ•°è¿‡é•¿ï¼‰
          RESPONSE=$(curl -s -X PUT \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @payload.json \
            "https://api.github.com/repos/$OWNER/$TARGET_REPO/contents/$(echo -n "$TARGET_FILENAME" | jq -sRr @uri)")

          # æ£€æŸ¥æ¨é€ç»“æœ
          if echo "$RESPONSE" | jq -e '.commit' > /dev/null; then
            echo "âœ… æ–‡ä»¶æ¨é€æˆåŠŸï¼"
            echo "ğŸ”— Commit: https://github.com/$OWNER/$TARGET_REPO/commit/$(echo "$RESPONSE" | jq -r '.commit.sha')"
          else
            echo "âŒ æ–‡ä»¶æ¨é€å¤±è´¥ï¼š$RESPONSE"
            exit 1
          fi

      - name: 6. æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        if: always()
        run: |
          rm -f main.pdf pdf_base64.txt payload.json
