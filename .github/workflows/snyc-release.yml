name: Sync Releases

on:
  workflow_dispatch:  # 手动触发
  release:
    types: [published]  # 源仓库发布时触发

jobs:
  deploy-pdf:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出当前仓库（解决"not in a git directory"错误）
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          # 仅检出最新的commit，不需要完整历史
          fetch-depth: 1

      # 2. 下载 Release 中的 main.pdf
      - name: Download PDF from Release
        run: |
          # 使用 GitHub API 获取 release 资产信息
          # 先获取 release 的资产信息，找到 main.pdf 的下载 URL
          echo "正在下载 Release ${{ github.event.release.tag_name }} 中的 PDF 文件..."
          
          # 使用 API 获取 release 资产信息
          ASSET_INFO=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ github.event.release.tag_name }}")
          
          # 提取 main.pdf 的下载 URL
          DOWNLOAD_URL=$(echo "$ASSET_INFO" | jq -r '.assets[] | select(.name=="main.pdf") | .url')
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "错误：在 Release 中未找到 main.pdf 文件"
            exit 1
          fi
          
          # 使用 API 下载文件
          curl -L \
            -H "Accept: application/octet-stream" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o "main.pdf" \
            "$DOWNLOAD_URL"
          
          echo "✅ PDF 文件下载完成"
          ls -la main.pdf

      # 3. 重命名并准备目录
      - name: Rename and prepare PDF directory
        run: |
          # 检查文件是否存在且有效
          if [ ! -f "main.pdf" ]; then
            echo "错误：main.pdf 文件不存在"
            exit 1
          fi
          
          # 验证是否为 PDF 文件
          file main.pdf | grep -q "PDF document"
          if [ $? -ne 0 ]; then
            echo "警告：文件可能不是有效的 PDF"
          fi
          
          # 创建目标目录
          mkdir -p pdf-output
          
          # 重命名并移动文件
          mv main.pdf pdf-output/"Note for Algebraic Varieties.pdf"
          
          echo "✅ 文件已重命名为: Note for Algebraic Varieties.pdf"
          ls -la pdf-output/

      # 4. 使用 GitHub CLI 推送到目标仓库（替代 JamesIves/github-pages-deploy-action）
      - name: Push PDF to target repository
        env:
          TARGET_REPO: "DRAMINGLING/Documents"  # ⚠️ 修改为目标仓库
          TARGET_BRANCH: "main"                   # ⚠️ 修改为目标分支
        run: |
          # 安装必要的工具
          sudo apt-get update
          
          # 配置 git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # 克隆目标仓库
          echo "克隆目标仓库 $TARGET_REPO..."
          git clone --depth 1 \
            "https://x-access-token:${{ secrets.UPDATE_TEX_FILE }}@github.com/$TARGET_REPO.git" \
            target-repo
          
          cd target-repo
          
          # 切换到目标分支
          git checkout $TARGET_BRANCH || git checkout -b $TARGET_BRANCH
          
          # 将 PDF 文件复制到目标仓库
          echo "复制 PDF 文件到目标仓库..."
          cp ../pdf-output/"Note for Algebraic Varieties.pdf" ./
          
          # 提交更改
          git add "Note for Algebraic Varieties.pdf"
          
          # 检查是否有更改需要提交
          if git diff --cached --quiet; then
            echo "没有更改需要提交"
          else
            # 提交更改
            git commit -m "Add/update Note for Algebraic Varieties from release ${{ github.event.release.tag_name }}"
            
            # 推送更改
            echo "推送更改到目标仓库..."
            git push origin $TARGET_BRANCH
            echo "✅ 文件已成功推送到目标仓库"
          fi
          
          # 清理
          cd ..
          rm -rf target-repo

      # 5. 清理临时文件
      - name: Clean up
        run: |
          rm -rf pdf-output
